{
  "title": "313-origin",
  "cells": [
    {
      "type": "code",
      "language": "sql",
      "data": "use hzsearch;\n\nSET hive.security.authorization.enabled=false;\nSET hive.auto.convert.join=TRUE;\nADD jar hdfs:///user/hzsearch/mars/hdfs-upload-dir/cpv-all-20170906-160604.jar;\nCREATE TEMPORARY FUNCTION Brand AS 'com.vdian.item.nlp.UDF.Brand';\nADD jar hdfs:///user/hzsearch/mars/hdfs-upload-dir/wdnlp-0.1.10-SNAPSHOT-20170111-165544.jar;\n\nCREATE TEMPORARY FUNCTION title AS 'com.weidian.udf.title';\n\n\n\n\nCREATE TABLE IF NOT EXISTS r_dd_wdbuyer_item_industry_brand\n(\n   id            string  comment \"商品id\",\n   seller        string  comment \"店铺id\",\n   add_time      string  comment \"添加时间\",\n   edit_time     string  comment \"编辑时间\",\n   update_time   string comment \"更新时间\",\n   status        string comment \"状态\",\n   times         string comment  \"时间戳\",                \n   cid4          string comment  \"叶子类目\",                \n   cid1          string comment  \"一级类目\",               \n   cid4_name     string comment  \"叶子类目名称\",             \n   cid1_name     string comment  \"一级类目名称\",             \n   accuracy      double comment  \"置信度\",                \n   item_comment  string comment \"商品名称\",\n   industry      string comment \"商品行业\",\n   brand         string comment \"品牌名称\"\n)partitioned BY (pt string);\n\nDROP TABLE IF EXISTS r_dd_wdbuyer_item_industry_brand_today;\nCREATE TABLE IF NOT EXISTS r_dd_wdbuyer_item_industry_brand_today AS\nSELECT id          \n       ,seller      \n       ,add_time    \n       ,edit_time   \n       ,update_time \n       ,status      \n       ,times       \n       ,cid4        \n       ,cid1        \n       ,cid4_name   \n       ,cid1_name   \n       ,accuracy    \n       ,item_comment\n       ,industry  \n       ,CASE WHEN item_comment IS NULL OR cid1 IS NULL OR cid4 IS NULL OR industry IS NULL THEN NULL\n       WHEN industry in (\"美妆\",\"百货\",\"服饰\",\"运动\",\"母婴\") and cid1 not in (\"50016349\",\"21\",\"50016348\") then Brand(regexp_replace(regexp_replace(title(item_comment),\"：\",\"\"),\":\",\"\"),cid4,cid1,industry)\n       ELSE NULL END AS brand\nFROM r_dd_wdbuyer_item_industry\nWHERE pt=\"${bizday}\" AND id not in (\"2170892152\",\"2175899042\",\"2181456791\",\"2194646617\",\"2202313430\",\"2206523544\",\"2206941293\",\"2208401756\",\"2212583564\",\"2220054951\");\n\nINSERT overwrite TABLE r_dd_wdbuyer_item_industry_brand partition(pt=\"${bizday}\")\nSELECT id          \n       ,seller      \n       ,add_time    \n       ,edit_time   \n       ,update_time \n       ,status      \n       ,times       \n       ,cid4        \n       ,cid1        \n       ,cid4_name   \n       ,cid1_name   \n       ,accuracy    \n       ,item_comment\n       ,industry\n       ,brand\nFROM r_dd_wdbuyer_item_industry_brand_today\nWHERE brand<>\"款儿\" or brand IS NULL\nUNION ALL\nSELECT  id          \n       ,seller      \n       ,add_time    \n       ,edit_time   \n       ,update_time \n       ,status      \n       ,times       \n       ,cid4        \n       ,cid1        \n       ,cid4_name   \n       ,cid1_name   \n       ,accuracy    \n       ,item_comment\n       ,industry     \n       ,brand\nFROM r_dd_wdbuyer_item_industry_brand \nWHERE pt=\"${bizday_1}\" AND (brand<>\"款儿\" or brand IS NULL);\n\n"
    }
  ]
}